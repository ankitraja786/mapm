<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div id="map" style="height: 400px;"></div>
  <input id="search" placeholder="Where to?" style="width:100%; padding:8px; margin-top:5px;">
  
  <script>
    // Initialize map
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Receive location from Appian
    window.addEventListener('message', (e) => {
      if(e.data.lat) {
        map.setView([e.data.lat, e.data.lng], 15);
        L.marker([e.data.lat, e.data.lng])
          .addTo(map)
          .bindPopup("You are here")
          .openPopup();
      }
    });

    // Search with Nominatim
    document.getElementById("search").addEventListener("change", async (e) => {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(e.target.value)}&format=json`);
      const [result] = await res.json();
      
      if(result) {
        parent.postMessage({
          name: result.display_name,
          lat: parseFloat(result.lat),
          lng: parseFloat(result.lon)
        }, "*");
      }
    });
  </script>
</body>
</html>
